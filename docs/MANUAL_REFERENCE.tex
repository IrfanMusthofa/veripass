\documentclass[12pt, a4paper]{report}

% PACKAGES
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage[english]{babel}
\usepackage{geometry}
\usepackage{fancyhdr}
\usepackage{titlesec}
\usepackage{setspace}
\usepackage{booktabs}
\usepackage{caption}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{palatino} % Use a serif font like Palatino

% GEOMETRY
\geometry{
    a4paper,
    total={170mm,257mm},
    left=20mm,
    top=20mm,
}
\setlength{\headheight}{15pt} % Increased headheight

% COLORS
\definecolor{primary}{HTML}{003366} % A dark blue color

% TITLE PAGE
\title{
    \vspace{2cm}
    \hrule
    \vspace{0.5cm}
    {\Huge \bfseries \color{primary} Sales Commission Management System} \\
    \vspace{0.5cm}
    {\large \it A Blockchain-Integrated Solution} \\
    \vspace{2cm}
    \hrule
    \vspace{2cm}
    {\Large Technical Documentation and User Guide} \\
    \vspace*{\fill}
}
\author{}
\date{January 3, 2026}


% HEADERS AND FOOTERS
\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{\nouppercase{\leftmark}}
\fancyhead[R]{\thepage}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0pt}

% CHAPTER STYLING
\titleformat{\chapter}[display]
  {\normalfont\huge\bfseries\color{primary}}
  {\chaptertitlename\ \thechapter}{20pt}{\Huge}
\titlespacing*{\chapter}{0pt}{-50pt}{40pt}

% SECTION STYLING
\titleformat{\section}{\normalfont\Large\bfseries\color{primary}}{\thesection}{1em}{}
\titleformat{\subsection}{\normalfont\large\bfseries}{\thesubsection}{1em}{}

% CODE LISTING STYLE
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}
\lstset{style=mystyle}

\lstdefinelanguage{Solidity}{
  keywords={abstract, after, alias, anonymous, apply, as, assembly, assert, assign,
            auto, break, case, catch, constant, continue, contract, default, define,
            defined, delete, deploy, do, else, enum, event, external, fallback,
            final, for, function, global, goto, if, immutable, implements, import,
            in, indexed, inlined, internal, is, let, library, mapping, memory,
            modifier, new, override, payable, pragma, private, public, pure,
            receive, return, returns, sealed, sizeof, static, storage, struct,
            super, switch, template, this, throw, transient, try, type, typeof,
            unchecked, using, view, virtual, while, with},
  keywordstyle=\color{blue}\bfseries,
  keywords=[2]{address, bool, bytes, bytes1, bytes2, bytes3, bytes4, bytes5, bytes6,
               bytes7, bytes8, bytes9, bytes10, bytes11, bytes12, bytes13, bytes14,
               bytes15, bytes16, bytes17, bytes18, bytes19, bytes20, bytes21,
               bytes22, bytes23, bytes24, bytes25, bytes26, bytes27, bytes28,
               bytes29, bytes30, bytes31, bytes32, int, int8, int16, int24, int32,
               int40, int48, int56, int64, int72, int80, int88, int96, int104,
               int112, int120, int128, int136, int144, int152, int160, int168,
               int176, int184, int192, int200, int208, int216, int224, int232,
               int240, int248, int256, string, uint, uint8, uint16, uint24,
               uint32, uint40, uint48, uint56, uint64, uint72, uint80, uint88,
               uint96, uint104, uint112, uint120, uint128, uint136, int144,
               uint152, int160, int168, uint176, int184, int192, int200,
               int208, int216, int224, int232, int240, int248, int256},
  keywordstyle=[2]\color{teal}\bfseries,
  keywords=[3]{block, msg, tx, blockhash, gasleft, now, selfdestruct, sha256,
               sha3, ripemd160, ecrecover, addmod, mulmod, keccak256, abi,
               super, this, true, false, owner, require, revert, balance,
               send},
  keywordstyle=[3]\color{violet}\bfseries,
  comment=[l]{//},
  commentstyle=\color{gray},
  stringstyle=\color{red},
  morestring=[b]",
  sensitive=true
}


% DOCUMENT START
\begin{document}

\maketitle
\tableofcontents
\listoffigures
\listoftables

\chapter{General Overview}

\section{System Description}
The Sales Commission Management System is a full-stack application designed to bring cryptographic truth to sales commission processing. It addresses the common issue of disputes arising from opaque, centralized commission systems where data can be manipulated without oversight.

This system employs a hybrid architecture:
\begin{itemize}
    \item A modern web application for a seamless user experience.
    \item An efficient off-chain database for handling detailed, high-volume transaction data.
    \item A secure on-chain smart contract for verifying the integrity of sales data and providing an immutable audit trail.
\end{itemize}
By recording a cryptographic hash of each transaction on the Ethereum blockchain, the system ensures that any modification to off-chain records is immediately detectable.

\section{Manual's Purpose}
This document serves as a comprehensive technical guide for developers, system administrators, and auditors. Its objectives are to provide a deep understanding of:
\begin{enumerate}
    \item The software architecture and its components.
    \item The setup and deployment process for all parts of the system.
    \item The detailed workflow for all user roles.
    \item A complete reference for the system's API and smart contract.
\end{enumerate}

\section{General Functionality}
The system provides the following key features:
\begin{itemize}
    \item Secure registration and authentication for all user roles (Agent, Auditor, Customer/Finance).
    \item Agent-driven submission of sales transactions.
    \item An automated Oracle service that validates off-chain data against on-chain records.
    \item Auditor tools to manually verify transaction integrity at any time.
    \item A finance interface to process payments for cryptographically verified commissions.
    \item An immutable, transparent log of all sales records on the blockchain.
\end{itemize}

\section{Main Components}
The system is comprised of four main interacting components, as illustrated in Figure \ref{fig:arch}.
\begin{enumerate}
    \item \textbf{Client Applications:} SvelteKit frontends tailored to different user roles.
    \item \textbf{Backend Server:} A Node.js server that exposes a REST API, handles business logic, and interacts with the database.
    \item \textbf{Database:} A SQLite database managed by Prisma ORM for storing user data, product catalogs, and detailed transaction records.
    \item \textbf{Blockchain Components:} An Ethereum-based smart contract (\texttt{SalesManager.sol}) and a background Oracle service that bridges the on-chain and off-chain worlds.
\end{enumerate}

\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.8\linewidth]{../Diagrams/Activity Diagram.png}
    \caption{System Architecture Overview}
    \label{fig:arch}
\end{figure}


\chapter{Software Architecture}

\section{Overall System Structure}
The application follows a client-server model augmented with blockchain services. The SvelteKit frontend communicates with a backend API. This backend, in turn, manages the local SQLite database and communicates with the Ethereum blockchain via an RPC connection managed by Ethers.js. A critical background process, the Oracle, continuously monitors the blockchain for events and triggers verification logic. The technologies used are summarized in Table \ref{tab:tech}.

\begin{table}[h!]
    \centering
    \caption{Technology Stack}
    \label{tab:tech}
    \begin{tabular}{ll}
        \toprule
        \textbf{Category} & \textbf{Technology} \\
        \midrule
        Frontend & SvelteKit, Tailwind CSS \\
        Backend & Node.js, SvelteKit \\
        Database & SQLite, Prisma ORM \\
        Blockchain & Solidity, Hardhat, Ethers.js \\
        Testing & Vitest, Playwright \\
        \bottomrule
    \end{tabular}
\end{table}

\section{Client-Side Components}
The frontend is a Single Page Application (SPA) built with SvelteKit and styled with Tailwind CSS. It provides different user interfaces based on the logged-in user's role.
\begin{itemize}
    \item \textbf{Agent Dashboard:} Allows sales agents to create new transactions and view the verification status of their past submissions.
    \item \textbf{Auditor Dashboard:} Provides a global view of all transactions and allows for manual integrity checks.
    \item \textbf{Customer/Finance Dashboard:} Lists all fully verified transactions that are ready for commission payment.
\end{itemize}

\section{Server-Side Components}
The backend is built with Node.js and SvelteKit's server-side capabilities.
\subsection{REST API}
The API provides endpoints for all client-side operations. It handles user authentication, data validation, and database interactions. See Chapter 5 for a full API reference.

\subsection{Prisma ORM}
Prisma is used to interact with the SQLite database. It provides type-safe database access and manages schema migrations. The schema is defined in \texttt{prisma/schema.prisma} and is detailed in Appendix B.

\subsection{Blockchain Service}
The \texttt{Blockchain\_Service.ts} module encapsulates all interactions with the Ethereum smart contract. It uses the \texttt{ethers.js} library to call contract functions and listen for events.

\subsection{Oracle Service}
The \texttt{oracle.ts} script is a long-running process that acts as the trusted bridge between the off-chain and on-chain worlds. It listens for \texttt{SaleRecorded} events from the \texttt{SalesManager} contract and triggers the \texttt{verify\_transaction} function after comparing the on-chain data with the database records.

\section{Blockchain Components}
\subsection{Hardhat Environment}
Hardhat is used as the development environment for the Ethereum smart contract. It facilitates compiling, deploying, testing, and debugging Solidity code.

\subsection{SalesManager Smart Contract}
This is the core on-chain component, written in Solidity. See Appendix A for the full source code.
\begin{itemize}
    \item \textbf{State Variables:} It stores sales data in a mapping from a transaction ID to a `Sale` struct. It also maintains addresses for the contract owner and the trusted Oracle.
    \item \textbf{Functions:} Includes functions for recording sales, verifying transactions, and updating payment status.
    \item \textbf{Events:} Emits events for key actions (\texttt{SaleRecorded}, \texttt{SaleVerificationResult}, \texttt{PaymentUpdated}) to allow off-chain services to react.
\end{itemize}

\chapter{Getting Started}

\section{Prerequisites}
Ensure the following software is installed on your system:
\begin{itemize}
    \item Node.js (v18 or newer) and npm
    \item Git
\end{itemize}

\section{Installation and Setup}
\subsection{Cloning the Repository}
\begin{lstlisting}[language=bash]
git clone <repository-url>
cd Tubes-Blockchain
\end{lstlisting}

\subsection{Installing Dependencies}
This command will install all necessary packages for the SvelteKit application, Prisma, Hardhat, and other development tools.
\begin{lstlisting}[language=bash]
npm install
\end{lstlisting}

\subsection{Database Configuration}
The system uses a local SQLite database.
\begin{enumerate}
    \item \textbf{Create the Database and Tables:} This command applies all pending migrations found in the \texttt{prisma/migrations} directory.
    \begin{lstlisting}[language=bash]
npx prisma migrate deploy
\end{lstlisting}
    \item \textbf{Seed the Database (Optional):} This populates the database with initial data for users and items, as defined in \texttt{prisma/seed.ts}.
    \begin{lstlisting}[language=bash]
npx prisma db seed
\end{lstlisting}
    \item \textbf{View the Database (Optional):} Prisma Studio provides a web interface to view and edit the database.
    \begin{lstlisting}[language=bash]
npx prisma studio
\end{lstlisting}
\end{enumerate}

\subsection{Running the Application}
Start the SvelteKit development server. This command also starts the backend API.
\begin{lstlisting}[language=bash]
npm run dev
\end{lstlisting}
The application will be accessible at \url{http://localhost:5173}.

\chapter{Application Usage}
This chapter provides a detailed guide for each user role.

\section{Agent Role}
Sales agents are responsible for submitting their sales for commission processing.
\begin{itemize}
    \item \textbf{Login:} Agents log in with their credentials.
    \item \textbf{Dashboard:} The agent dashboard displays a list of their past transactions and their current status (e.g., Unverified, Pending, Paid).
    \item \textbf{New Transaction:} Agents can create a new transaction by selecting items and quantities. Upon submission, the backend creates a database record and returns a hash. The agent's browser then prompts them to sign a blockchain transaction using their wallet to record this hash on-chain.
\end{itemize}

\section{Auditor Role}
Auditors are responsible for ensuring the integrity of the sales data.
\begin{itemize}
    \item \textbf{Login:} Auditors log in with their credentials.
    \item \textbf{Dashboard:} The auditor dashboard shows a list of all transactions in the system.
    \item \textbf{Integrity Check:} An auditor can click on any transaction to trigger a manual integrity check. This action calls a dedicated API endpoint that compares the hash stored in the database with the hash stored on the blockchain and displays the result.
\end{itemize}

\section{Customer/Finance Role}
The finance department is responsible for paying commissions on verified sales.
\begin{itemize}
    \item \textbf{Login:} Finance users log in with their credentials.
    \item \textbf{Dashboard:} The finance dashboard displays only transactions that have been successfully verified by the Oracle (\texttt{isVerified = true}) and are not yet paid (\texttt{isPaid = false}).
    \item \textbf{Process Payment:} The user can select transactions and click a "Pay" button. This triggers a backend process where the Oracle's wallet calls the \texttt{update\_payment} function on the smart contract to mark the transaction as paid on-chain. The database is then updated to reflect this change.
\end{itemize}

\chapter{API Reference}
The API is documented using OpenAPI specification in \texttt{openapi.yaml} and can be viewed interactively with Swagger UI. Start the development server and navigate to \url{http://localhost:5173/docs.html}.

\section{Agent Endpoints}
\begin{itemize}
    \item \textbf{GET \texttt{/api/agents/items}} \\
    Fetches a list of all available items for sale.
    \item \textbf{POST \texttt{/api/agents/[id]/transaction}} \\
    Creates a new transaction. Expects a body with an \texttt{items} array.
    \item \textbf{GET \texttt{/api/agents/[id]/transactions}} \\
    Retrieves the transaction history for a specific agent.
\end{itemize}

\section{Auditor Endpoints}
\begin{itemize}
    \item \textbf{GET \texttt{/api/auditors/[id]/integrity/[tx\_id]}} \\
    Performs an integrity check on a transaction.
    \item \textbf{PUT \texttt{/api/auditors/flag/[tx\_id]}} \\
    Flags a transaction as suspicious.
\end{itemize}

\section{Customer Endpoints}
\begin{itemize}
    \item \textbf{GET \texttt{/api/customer}} \\
    Retrieves all verified transactions awaiting payment.
    \item \textbf{PUT \texttt{/api/customer}} \\
    Marks a transaction as paid. Expects a body with \texttt{transaction\_Id}.
\end{itemize}

\appendix
\chapter{Smart Contract Source Code}
\lstinputlisting[language=Solidity]{../contracts/SalesManager.sol}

\chapter{Database Schema}
\lstinputlisting[language=bash]{../prisma/schema.prisma}

\end{document}
